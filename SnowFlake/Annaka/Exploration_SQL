-- Take note:
--  1. POR_DELIVERY_DATE and DELIVERY_DATE are sometimes different
-- what is the difference between 17 and 22



-- 1 investigating
SELECT POR_DELIVERY_DATE, DELIVERY_DATE
FROM PURCHASE_ORDER_HISTORY
WHERE POR_DELIVERY_DATE is not null
LIMIT 200
;

-- 2 investigating
SELECT VENDOR_ID, POSTAL_CD
FROM PURCHASE_ORDER_HISTORY
LIMIT 100
;


-- 3 investigating
SELECT RELEASE_DATE, CREATE_DATE
FROM PURCHASE_ORDER_HISTORY
WHERE RELEASE_DATE is not null
LIMIT 100
;


-- 4 investigation count nulls
SELECT COUNT(POR_DELIVERY_DATE_ML) FROM PURCHASE_ORDER_HISTORY WHERE POR_DELIVERY_DATE_ML is  NULL;

SELECT COUNT(FIRST_GR_POSTING_DATE_ML) FROM PURCHASE_ORDER_HISTORY WHERE FIRST_GR_POSTING_DATE_ML is NULL;

SELECT COUNT(RELEASE_DATE_ML) FROM PURCHASE_ORDER_HISTORY WHERE RELEASE_DATE_ML is NULL;


-- 5 investigating
SELECT REQUESTED_DELIVERY_DATE_ML, FIRST_GR_POSTING_DATE_ML
FROM PURCHASE_ORDER_HISTORY
LIMIT 100
;

-- 6 attempt to fill in nulls
-- Calculate the expected delivery date
SELECT
    FIRST_GR_POSTING_DATE_ML,
    RELEASE_DATE_ML,
    PLANNED_DELIVERY_DAYS
FROM
    PURCHASE_ORDER_HISTORY;

-- Fill in missing FIRST_GR_POSTING_DATE_ML data
UPDATE PURCHASE_ORDER_HISTORY
SET FIRST_GR_POSTING_DATE_ML = DATEADD(DAY, PLANNED_DELIVERY_DAYS, RELEASE_DATE_ML)
WHERE
    FIRST_GR_POSTING_DATE_ML IS NULL 
    AND (RELEASE_DATE_ML IS NOT NULL AND PLANNED_DELIVERY_DAYS IS NOT NULL)
    ;

-- Fill in missing PLANNED_DELIVERY_DAYS data
UPDATE PURCHASE_ORDER_HISTORY
SET PLANNED_DELIVERY_DAYS = DATEDIFF(DAY, RELEASE_DATE_ML, FIRST_GR_POSTING_DATE_ML)
WHERE
    PLANNED_DELIVERY_DAYS IS NULL 
    AND (RELEASE_DATE_ML IS NOT NULL AND FIRST_GR_POSTING_DATE_ML IS NOT NULL)
    ;

    
-- Fill in missing RELEASE_DATE_ML data
UPDATE PURCHASE_ORDER_HISTORY
SET RELEASE_DATE_ML = DATEADD(DAY, -PLANNED_DELIVERY_DAYS, FIRST_GR_POSTING_DATE_ML)
WHERE
    RELEASE_DATE_ML IS NULL 
    AND (FIRST_GR_POSTING_DATE_ML IS NOT NULL AND PLANNED_DELIVERY_DAYS IS NOT NULL)
    ;


-- investigate if there is any other document type that is not INVISTA_PO
SELECT PURCHASE_DOCUMENT_ITEM_ID
FROM PURCHASE_ORDER_HISTORY;
WHERE PURCHASE_DOCUMENT_ITEM_ID != "INVISTA_PO"
;

-- trying to work w outliers in planned days column
SELECT DISTINCT PLANNED_DELIVERY_DAYS -- COUNT()
FROM PURCHASE_ORDER_HISTORY
;

SELECT 
    AVG(PLANNED_DELIVERY_DAYS) AS Average,
    STDDEV(PLANNED_DELIVERY_DAYS) AS StdDeviation,
    MIN(PLANNED_DELIVERY_DAYS) AS Min,
    MAX(PLANNED_DELIVERY_DAYS) AS Max
FROM 
    PURCHASE_ORDER_HISTORY
WHERE 
    PLANNED_DELIVERY_DAYS = '2023-05-30T23:07:43.64Z';
    --LENGTH(PLANNED_DELIVERY_DAYS) > 6;

-- actually working code
SELECT 
    AVG(CAST(PLANNED_DELIVERY_DAYS AS DECIMAL)) AS Average,
    STDDEV(CAST(PLANNED_DELIVERY_DAYS AS DECIMAL)) AS StdDeviation,
    MIN(CAST(PLANNED_DELIVERY_DAYS AS DECIMAL)) AS Min,
    MAX(CAST(PLANNED_DELIVERY_DAYS AS DECIMAL)) AS Max,
    MEDIAN(CAST(PLANNED_DELIVERY_DAYS AS DECIMAL)) as median
FROM 
    PURCHASE_ORDER_HISTORY
WHERE 
    LENGTH(PLANNED_DELIVERY_DAYS) < 6
    AND
    PLANNED_DELIVERY_DAYS <> 0;

SELECT 
    COUNT(*) - COUNT(PURCHASE_DOCUMENT_ID) AS PURCHASE_DOCUMENT_ID_Null_Count, --0
    COUNT(*) - COUNT(CREATE_DATE_ML) AS CREATE_DATE_Null_Count, --0
    COUNT(*) - COUNT(COMPANY_CODE_ID) AS COMPANY_CODE_ID_Null_Count, --15
    COUNT(*) - COUNT(VENDOR_ID) AS VENDOR_ID_Null_Count, --198812
    COUNT(*) - COUNT(POSTAL_CD) AS PLANNED_DELIVERY_DAYS_Null_Count, --200371
--    COUNT(*) - COUNT(RELEASE_DATE_ML) AS PLANNED_DELIVERY_DAYS_Null_Count, --1075853
    COUNT(*) - COUNT(PURCHASE_DOCUMENT_ITEM_ID) AS PLANNED_DELIVERY_DAYS_Null_Count, -- 15
    COUNT(*) - COUNT(MATERIAL_ID) AS PLANNED_DELIVERY_DAYS_Null_Count, --520519
    COUNT(*) - COUNT(SUB_COMMODITY_DESC) AS PLANNED_DELIVERY_DAYS_Null_Count, --1040
    COUNT(*) - COUNT(PLANT_ID) AS PLANNED_DELIVERY_DAYS_Null_Count, --37184
--    COUNT(*) - COUNT(POR_DELIVERY_DATE_ML) AS PLANNED_DELIVERY_DAYS_Null_Count, --804579
    COUNT(*) - COUNT(FIRST_GR_POSTING_DATE_ML) AS PLANNED_DELIVERY_DAYS_Null_Count, --130291
--    COUNT(*) - COUNT(DELIVERY_DATE) AS DELIVERY_DATE_Null_Count, --45651
    COUNT(*) - COUNT(INBOUND_DELIVERY_ITEM_ID) AS PLANNED_DELIVERY_DAYS_Null_Count, --15
    COUNT(*) - COUNT(INBOUND_DELIVERY_ID) AS PLANNED_DELIVERY_DAYS_Null_Count, --679520
    COUNT(*) - COUNT(PLANNED_DELIVERY_DAYS) AS PLANNED_DELIVERY_DAYS_Null_Count, --15
FROM 
    PURCHASE_ORDER_HISTORY;

-- WHERE 
--     PURCHASE_DOCUMENT_ID <> 0 AND
--     CREATE_DATE_ML <> 0 AND
--     COMPANY_CODE_ID <> '0' AND
--     VENDOR_ID <> '0' AND
--     POSTAL_CD <> '0' AND
--     RELEASE_DATE_ML <> 0 AND
--     PURCHASE_DOCUMENT_ITEM_ID <> 0 AND
--     MATERIAL_ID <> 0 AND
--     SUB_COMMODITY_DESC <> '0' AND
--     PLANT_ID <> 0 AND
--     POR_DELIVERY_DATE_ML <> 0 AND
--     FIRST_GR_POSTING_DATE_ML <> 0 AND
--     INBOUND_DELIVERY_ID <> 0 AND
--     INBOUND_DELIVERY_ITEM_ID <> 0 AND
--     PLANNED_DELIVERY_DAYS <> '0'
-- ;
